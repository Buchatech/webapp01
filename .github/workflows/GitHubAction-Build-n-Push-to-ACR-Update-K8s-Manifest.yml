on: [push]

env:
  IMAGE_NAME: webapp01
  # ${{ env.IMAGE_NAME }}
  ACR_NAME: acr01
  # ${{ env.ACR_NAME }}
  RG_NAME: webpp01RG
  # ${{ env.RG_NAME }}
  REGION_LOCATION: "EAST US"
  # ${{ env.REGION_LOCATION }}

jobs:
  Build-and-Push:
    name: Build and push Docker image to ACR
    runs-on: ubuntu-latest
    steps:
    
    - uses: actions/checkout@main
    
    - uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Create ACR
      id: create-acr
      run: |
        az acr create -n ${{ env.ACR_NAME }} -g ${{ env.RG_NAME }} --location "${{ env.REGION_LOCATION }}" --sku Standard --admin-enabled
        echo "::set-output name=acr_username::`az acr credential show -n ${{ env.ACR_NAME }} --query username | xargs`"
        echo "::set-output name=acr_password::`az acr credential show -n ${{ env.ACR_NAME }} --query passwords[0].value | xargs`"
        echo "::add-mask::`az acr credential show -n ${{ env.ACR_NAME }} --query passwords[0].value | xargs`"

    - uses: azure/docker-login@v1
      with:
        login-server: ${{ env.ACR_NAME }}.azurecr.io
        username: ${{ steps.create-acr.outputs.acr_username }}
        password: ${{ steps.create-acr.outputs.acr_password }}

    - name: Build and push image to ACR
      id: build-image
      run: |
        docker build "$GITHUB_WORKSPACE/" -f  "Dockerfile" -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.run_number }} --label dockerfile-path=Dockerfile
        docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.run_number }}


  Update-K8s-Manifests:
    name: Update K8s Deployment Manifest with Image Version
    needs: Build-and-Push
    runs-on: ubuntu-latest
    steps:

    - uses: actions/checkout@v2

    - name: Update Image Version
      id: imgupd
      uses: mikefarah/yq@master
      with:
        cmd: yq eval '.spec.template.spec.containers[0].image = "${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.run_number }}"' -i manifests/deployment.yml
      
    - uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: Update image version in K8s Deployment manifests file
