on: [push]

env:
  IMAGE_NAME: webapp01
  ACR_NAME: acr01
  RG_NAME: webpp01RG
  LOCATION_SET: "EAST US"

jobs:
  Build-and-Push:
    name: Build and push Docker image to ACR
    runs-on: ubuntu-latest
    steps:
    
    - uses: actions/checkout@main
    
    - uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Create ACR
      id: create-acr
      run: |
        az acr create -n 51822acr -g 51822acrbb45-rg --location "East US" --sku Standard --admin-enabled
        echo "::set-output name=acr_username::`az acr credential show -n 51822acr --query username | xargs`"
        echo "::set-output name=acr_password::`az acr credential show -n 51822acr --query passwords[0].value | xargs`"
        echo "::add-mask::`az acr credential show -n 51822acr --query passwords[0].value | xargs`"

    - uses: azure/docker-login@v1
      with:
        login-server: 51822acr.azurecr.io
        username: ${{ steps.create-acr.outputs.acr_username }}
        password: ${{ steps.create-acr.outputs.acr_password }}

    - name: Build and push image to ACR
      id: build-image
      run: |
        docker build "$GITHUB_WORKSPACE/" -f  "Dockerfile" -t 51822acr.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.run_number }} --label dockerfile-path=Dockerfile
        docker push 51822acr.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.run_number }}


  Update-K8s-Manifests:
    name: Update K8s Deployment Manifest with Image Version
    needs: Build-and-Push
    runs-on: ubuntu-latest
    steps:

    - uses: actions/checkout@v2

    - name: Update Image Version
      id: imgupd
      uses: mikefarah/yq@master
      with:
        cmd: yq eval '.spec.template.spec.containers[0].image = "51822acr.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.run_number }}"' -i manifests/deployment.yml
      
    - uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: Update image version in K8s Deployment manifests file
